<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reten√ß√£o de Notas - Contajur</title>
    <!-- Link para o CSS. Crie este arquivo na pasta static/ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='retencao.css') }}">
</head>
<body>
    <!-- Bot√£o Voltar -->
    <a href="{{ url_for('index') }}" class="back-btn">Voltar</a>

    <!-- Elementos flutuantes de fundo (se voc√™ tiver CSS para eles) -->
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <div class="container">
        <h1>Relat√≥rio de Reten√ß√£o de Notas</h1>
        <p>Arraste e solte seus arquivos PDF aqui, ou clique na √°rea abaixo para selecionar.</p>
        
        <!-- Se√ß√£o para Upload de PDFs -->
        <div class="upload-area" id="uploadArea">
            <p>üìÅ Arraste e solte arquivos PDF aqui ou</p>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Selecionar Arquivos</button>
            <input type="file" id="fileInput" class="file-input" multiple accept=".pdf">
        </div>
        
        <!-- Lista de arquivos selecionados -->
        <div class="file-list" id="fileList"></div>
        
        <!-- Bot√£o de processamento -->
        <button class="process-btn" id="processBtn" onclick="processFiles()" disabled>Gerar Relat√≥rio</button>
        
        <!-- √Årea de loading -->
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Processando arquivos...</p>
        </div>
        
        <!-- √Årea de resultados -->
        <div id="results"></div>
    </div>

    <script>
        let selectedFiles = []; // Array para armazenar m√∫ltiplos arquivos selecionados
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        // Event listeners para drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            addFiles(files);
        });

        // Event listener para sele√ß√£o de arquivos via input
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addFiles(files);
        });

        // Fun√ß√£o para adicionar arquivos √† lista (evita duplicatas por nome)
        function addFiles(files) {
            files.forEach(file => {
                // Adiciona apenas se o arquivo n√£o estiver j√° na lista (comparando pelo nome)
                if (!selectedFiles.find(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            });
            updateFileList();
            updateProcessButton();
        }
        
        // Fun√ß√£o para atualizar a exibi√ß√£o da lista de arquivos
        function updateFileList() {
            fileList.innerHTML = ''; // Limpa a lista atual
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>üìÑ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    <div>
                        <button class="remove-btn" onclick="removeFile(${index})">Remover</button>
                    </div>
                `;
                fileList.appendChild(fileItem);
            });
        }
        
        // Fun√ß√£o para remover um arquivo da lista
        function removeFile(index) {
            selectedFiles.splice(index, 1); // Remove o arquivo do array
            fileInput.value = null; // Reinicia o input para permitir re-sele√ß√£o do mesmo arquivo
            updateFileList();
            updateProcessButton();
        }

        // Fun√ß√£o para habilitar/desabilitar o bot√£o de processar
        function updateProcessButton() {
            processBtn.disabled = selectedFiles.length === 0;
        }

        // Fun√ß√£o principal para processar os arquivos
        async function processFiles() {
            if (selectedFiles.length === 0) {
                alert('Por favor, selecione pelo menos um arquivo PDF.');
                return;
            }
            
            loading.style.display = 'block'; // Mostra o spinner de loading
            results.innerHTML = ''; // Limpa resultados anteriores
            processBtn.disabled = true; // Desabilita o bot√£o de processar
            
            try {
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('pdfs', file); // Anexa cada arquivo PDF com o nome 'pdfs'
                });
                
                // Envia os arquivos para o endpoint Flask
                const response = await fetch('/retencao_notas/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // Se a resposta for OK, baixa o arquivo de relat√≥rio
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'relatorio_notas_fiscais.txt'; // Nome do arquivo a ser baixado
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url); // Libera a URL do objeto Blob
                    
                    results.innerHTML = `
                        <div class="results success">
                            <h3>‚úÖ Relat√≥rio Gerado!</h3>
                            <p>O arquivo relatorio_notas_fiscais.txt foi baixado.</p>
                        </div>
                    `;
                } else {
                    // Se houver um erro na resposta do servidor
                    const errorText = await response.text();
                    results.innerHTML = `
                        <div class="results error">
                            <h3>‚ùå Erro no Processamento</h3>
                            <p>${errorText}</p>
                        </div>
                    `;
                }
            } catch (error) {
                // Erros de rede ou outros erros na requisi√ß√£o
                console.error('Erro na requisi√ß√£o:', error);
                results.innerHTML = `
                    <div class="results error">
                        <h3>‚ùå Erro de Conex√£o</h3>
                        <p>N√£o foi poss√≠vel conectar com o servidor.</p>
                        <p><strong>Erro:</strong> ${error.message}</p>
                    </div>
                `;
            } finally {
                loading.style.display = 'none'; // Esconde o spinner
                processBtn.disabled = false; // Reabilita o bot√£o
                resetForm(); // Limpa o formul√°rio ap√≥s o processamento
            }
        }

        // Fun√ß√£o para resetar o formul√°rio
        function resetForm() {
            selectedFiles = [];
            fileInput.value = null; // Limpa o input de arquivo
            fileList.innerHTML = ''; // Limpa a lista visual
            results.innerHTML = ''; // Limpa os resultados
            updateProcessButton(); // Atualiza o estado do bot√£o de processar
        }

        // Inicializa o estado do bot√£o ao carregar a p√°gina
        updateProcessButton();
    </script>
</body>
</html>
